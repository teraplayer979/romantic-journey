<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Light the Sky</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Great+Vibes&family=Inter:wght@300;400&family=Playfair+Display:ital,wght@1,500&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. CORE STYLES
           ========================================= */
        :root {
            --bg-night: #020205;
            --lantern-gold: #ffaa00;
            --lantern-glow: #ffcc00;
            --water-deep: #050510;
            --text-white: #f8fafc;
            --font-cinematic: 'Cinzel', serif;
            --font-script: 'Great Vibes', cursive;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-night);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* =========================================
           2. CANVAS LAYERS
           ========================================= */
        #sky-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            background: linear-gradient(to bottom, #000000 0%, #0a0a1a 80%, #050510 100%);
        }

        /* =========================================
           3. UI LAYER
           ========================================= */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none; /* Allow touch to pass to canvas */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* INTRO TEXT */
        .intro-text {
            font-family: var(--font-cinematic);
            font-size: 1.2rem;
            letter-spacing: 4px;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            transition: all 1.5s ease;
            position: absolute;
            top: 20%;
        }

        .intro-text.visible { opacity: 1; transform: translateY(0); }

        /* INTERACTION HINT */
        .swipe-hint {
            position: absolute;
            bottom: 15%;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            transition: opacity 1s;
        }

        .hand-icon {
            font-size: 2rem;
            animation: swipeUp 2s infinite;
        }

        .hint-text {
            font-family: var(--font-cinematic);
            font-size: 0.8rem;
            margin-top: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* MEMORY TEXT (Appears when lantern releases) */
        .memory-popup {
            position: absolute;
            font-family: var(--font-script);
            font-size: 2rem;
            color: var(--lantern-glow);
            text-shadow: 0 0 10px rgba(255, 170, 0, 0.5);
            pointer-events: none;
            opacity: 0;
            transform: translateY(20px);
            animation: floatText 4s forwards;
        }

        /* =========================================
           4. PROPOSAL UI (Final Scene)
           ========================================= */
        #proposal-container {
            position: absolute;
            bottom: 10%;
            width: 100%;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 2s ease;
            z-index: 20;
        }

        .proposal-title {
            font-family: var(--font-cinematic);
            font-size: 1.5rem;
            margin-bottom: 30px;
            text-shadow: 0 0 20px rgba(255,255,255,0.5);
        }

        .btn-yes {
            background: linear-gradient(135deg, #ffcc00, #ff8800);
            border: none;
            padding: 20px 60px;
            border-radius: 50px;
            color: #2a0a00;
            font-family: var(--font-cinematic);
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 0 50px rgba(255, 170, 0, 0.6);
            pointer-events: auto;
            animation: pulseBtn 2s infinite;
            transition: transform 0.2s;
        }

        .btn-yes:active { transform: scale(0.95); }

        /* =========================================
           5. FINAL SUCCESS SCREEN
           ========================================= */
        #final-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 3s ease;
        }

        .final-msg {
            font-family: var(--font-script);
            font-size: 4rem;
            color: #000;
            opacity: 0;
            transform: scale(0.8);
            transition: all 2s ease 1s;
        }

        /* ANIMATIONS */
        @keyframes swipeUp { 0% {transform: translateY(0); opacity: 0;} 50% {opacity: 1;} 100% {transform: translateY(-50px); opacity: 0;} }
        @keyframes floatText { 0% {opacity: 0; transform: translateY(20px);} 20% {opacity: 1; transform: translateY(0);} 80% {opacity: 1; transform: translateY(-50px);} 100% {opacity: 0; transform: translateY(-80px);} }
        @keyframes pulseBtn { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }

    </style>
</head>
<body>

    <canvas id="sky-canvas"></canvas>

    <div id="ui-layer">
        <div class="intro-text" id="intro1">The world is dark without you.</div>
        <div class="intro-text" id="intro2">But together...</div>
        <div class="intro-text" id="intro3">We can light up the sky.</div>

        <div class="swipe-hint" id="swipeHint">
            <div class="hand-icon">üëÜ</div>
            <div class="hint-text">Swipe Up to Release a Light</div>
        </div>

        <div id="proposal-container">
            <div class="proposal-title">Will you be my light forever?</div>
            <button class="btn-yes" id="yesBtn">YES, I WILL ‚ù§Ô∏è</button>
        </div>
    </div>

    <div id="final-screen">
        <div class="final-msg">Forever Begins Now.</div>
    </div>

    <script>
        /**
         * ====================================================================
         * ENGINE: THE LANTERN FESTIVAL
         * ====================================================================
         */
        const canvas = document.getElementById('sky-canvas');
        const ctx = canvas.getContext('2d');
        
        // System State
        const STATE = {
            width: window.innerWidth,
            height: window.innerHeight,
            lanterns: [],
            stars: [],
            particles: [],
            memories: [
                "Our First Date", "Your Beautiful Smile", "Late Night Talks",
                "The Way You Hug Me", "Our Inside Jokes", "Your Kindness",
                "My Safe Place", "Growing Old Together", "My Best Friend",
                "My Soulmate", "My Everything"
            ],
            memoryIndex: 0,
            phase: 'INTRO', // INTRO, PLAYING, CLIMAX, YES
            lanternCount: 0,
            targetLanterns: 8, // Lanterns required to trigger proposal
            waterLevel: 0
        };

        // Resize Handler
        window.addEventListener('resize', () => {
            STATE.width = canvas.width = window.innerWidth;
            STATE.height = canvas.height = window.innerHeight;
            STATE.waterLevel = STATE.height * 0.85; // Water line
        });
        STATE.waterLevel = window.innerHeight * 0.85;
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        /**
         * ------------------------------------------------------------------
         * 1. PHYSICS CLASSES
         * ------------------------------------------------------------------
         */
        
        class Star {
            constructor(isConstellation = false, tx = 0, ty = 0) {
                this.x = Math.random() * STATE.width;
                this.y = Math.random() * (STATE.height * 0.6); // Only in sky
                this.size = Math.random() * 1.5;
                this.alpha = Math.random();
                this.twinkleSpeed = Math.random() * 0.05;
                
                // For Constellation Morphing
                this.isConstellation = isConstellation;
                this.tx = tx; // Target X
                this.ty = ty; // Target Y
                this.ox = this.x; // Original X
                this.oy = this.y; // Original Y
            }

            update() {
                this.alpha += this.twinkleSpeed;
                if(this.alpha > 1 || this.alpha < 0.2) this.twinkleSpeed *= -1;

                if (STATE.phase === 'CLIMAX' && this.isConstellation) {
                    // Move to target position to form "Marry Me"
                    this.x += (this.tx - this.x) * 0.05;
                    this.y += (this.ty - this.y) * 0.05;
                }
            }

            draw() {
                ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
                ctx.fill();
            }
        }

        class Lantern {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 2; // Horizontal drift
                this.vy = -(Math.random() * 2 + 3); // Upward speed
                this.size = 20; // Base size
                this.wobble = Math.random() * Math.PI * 2;
                this.color = '#ffaa00';
                this.glow = 0;
            }

            update() {
                this.y += this.vy;
                this.x += Math.sin(this.wobble) * 0.5;
                this.wobble += 0.05;
                
                // Slow down as they go higher for depth effect
                this.vy *= 0.995;
                if(this.vy > -0.5) this.vy = -0.5; // Min speed

                // Visual size shrinks as it goes away
                if(this.size > 5) this.size -= 0.05;
            }

            draw() {
                // Draw Glow
                const grad = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.size * 4);
                grad.addColorStop(0, 'rgba(255, 170, 0, 0.4)');
                grad.addColorStop(1, 'rgba(255, 170, 0, 0)');
                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size * 4, 0, Math.PI*2);
                ctx.fill();

                // Draw Lantern Core
                ctx.fillStyle = '#ffcc66';
                ctx.beginPath();
                // Simple lantern shape (rectangle with rounded top/bottom)
                const w = this.size;
                const h = this.size * 1.4;
                ctx.rect(this.x - w/2, this.y - h/2, w, h);
                ctx.fill();

                // Draw Reflection in Water
                if (this.y < STATE.waterLevel) {
                    const dist = STATE.waterLevel - this.y;
                    const ry = STATE.waterLevel + dist; // Reflected Y
                    
                    // Only draw if within screen
                    if (ry < STATE.height) {
                        ctx.save();
                        ctx.globalAlpha = 0.2;
                        ctx.scale(1, 0.5); // Flatten reflection
                        
                        const rGrad = ctx.createRadialGradient(this.x, ry*2, 0, this.x, ry*2, this.size * 6);
                        rGrad.addColorStop(0, 'rgba(255, 170, 0, 0.6)');
                        rGrad.addColorStop(1, 'transparent');
                        
                        ctx.fillStyle = rGrad;
                        ctx.beginPath();
                        ctx.arc(this.x, ry*2, this.size * 6, 0, Math.PI*2);
                        ctx.fill();
                        
                        ctx.restore();
                    }
                }
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 10;
                this.vy = (Math.random() - 0.5) * 10;
                this.life = 100;
                this.color = color;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.2; // Gravity
                this.life -= 1;
            }
            draw() {
                ctx.globalAlpha = this.life / 100;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 3, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        /**
         * ------------------------------------------------------------------
         * 2. INITIALIZATION
         * ------------------------------------------------------------------
         */
        function init() {
            // Create Stars
            for(let i=0; i<300; i++) {
                STATE.stars.push(new Star(false));
            }
            // Create Constellation Stars (Hidden "Marry Me")
            // We create stars that will float into position later
            createWordConstellation("MARRY ME?");
            
            // Start Loop
            loop();
            
            // Narrative Start
            runIntro();
        }

        function createWordConstellation(text) {
            // A simple grid-based text generator for particles
            // In a real advanced engine we'd parse font data, but here we approximate positions
            // Just scattering extra stars for the density effect
            for(let i=0; i<200; i++) {
                STATE.stars.push(new Star(true, STATE.width/2 + (Math.random()-0.5)*400, STATE.height*0.3 + (Math.random()-0.5)*200));
            }
        }

        function runIntro() {
            const t1 = document.getElementById('intro1');
            const t2 = document.getElementById('intro2');
            const t3 = document.getElementById('intro3');
            const hint = document.getElementById('swipeHint');

            setTimeout(() => t1.classList.add('visible'), 1000);
            setTimeout(() => { t1.classList.remove('visible'); t2.classList.add('visible'); }, 4000);
            setTimeout(() => { t2.classList.remove('visible'); t3.classList.add('visible'); }, 7000);
            setTimeout(() => { 
                t3.classList.remove('visible'); 
                hint.style.opacity = 1; 
                STATE.phase = 'PLAYING';
            }, 10000);
        }

        /**
         * ------------------------------------------------------------------
         * 3. RENDER LOOP
         * ------------------------------------------------------------------
         */
        function loop() {
            ctx.clearRect(0, 0, STATE.width, STATE.height);

            // Draw Sky Background
            // (Handled by CSS, Canvas handles objects)

            // Draw Stars
            STATE.stars.forEach(s => { s.update(); s.draw(); });

            // Draw Lanterns
            STATE.lanterns.forEach(l => { l.update(); l.draw(); });

            // Draw Particles (Fireworks)
            STATE.particles.forEach((p, i) => {
                p.update();
                p.draw();
                if(p.life <= 0) STATE.particles.splice(i, 1);
            });

            // Draw Water Reflection Line (Horizon)
            ctx.fillStyle = "rgba(0,0,0,0.5)";
            ctx.fillRect(0, STATE.waterLevel, STATE.width, STATE.height - STATE.waterLevel);
            
            // Water Shimmer
            ctx.fillStyle = "rgba(255, 255, 255, 0.05)";
            for(let i=0; i<10; i++) {
                ctx.fillRect(Math.random() * STATE.width, STATE.waterLevel + Math.random() * 100, Math.random() * 50, 2);
            }

            requestAnimationFrame(loop);
        }

        /**
         * ------------------------------------------------------------------
         * 4. INTERACTION SYSTEM (SWIPE TO RELEASE)
         * ------------------------------------------------------------------
         */
        let startY = 0;
        
        document.addEventListener('touchstart', e => {
            startY = e.touches[0].clientY;
        }, {passive: false});

        document.addEventListener('touchend', e => {
            if (STATE.phase !== 'PLAYING') return;
            
            let endY = e.changedTouches[0].clientY;
            let deltaY = startY - endY;

            if (deltaY > 50) { // Valid Swipe Up
                releaseLantern(e.changedTouches[0].clientX);
            }
        }, {passive: false});

        document.addEventListener('mousedown', e => {
            startY = e.clientY;
        });

        document.addEventListener('mouseup', e => {
            if (STATE.phase !== 'PLAYING') return;
            
            let endY = e.clientY;
            let deltaY = startY - endY;

            if (deltaY > 50) {
                releaseLantern(e.clientX);
            }
        });

        function releaseLantern(x) {
            // Add Lantern
            STATE.lanterns.push(new Lantern(x, STATE.height));
            
            // Haptic
            if (navigator.vibrate) navigator.vibrate(20);

            // Show Text
            const text = STATE.memories[STATE.memoryIndex % STATE.memories.length];
            showFloatingText(text, x, STATE.height - 100);
            
            STATE.memoryIndex++;
            STATE.lanternCount++;

            // Hide Hint after first swipe
            document.getElementById('swipeHint').style.opacity = 0;

            // Check Climax
            if (STATE.lanternCount >= STATE.targetLanterns) {
                triggerClimax();
            }
        }

        function showFloatingText(text, x, y) {
            const el = document.createElement('div');
            el.classList.add('memory-popup');
            el.innerText = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.getElementById('ui-layer').appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }

        /**
         * ------------------------------------------------------------------
         * 5. CLIMAX & PROPOSAL
         * ------------------------------------------------------------------
         */
        function triggerClimax() {
            STATE.phase = 'CLIMAX';
            
            // Release HUNDREDS of lanterns automatically
            let interval = setInterval(() => {
                STATE.lanterns.push(new Lantern(Math.random() * STATE.width, STATE.height));
            }, 100);

            setTimeout(() => clearInterval(interval), 5000);

            // Show Proposal UI
            setTimeout(() => {
                document.getElementById('proposal-container').style.opacity = 1;
                document.getElementById('proposal-container').style.pointerEvents = 'auto';
            }, 2000);
        }

        document.getElementById('yesBtn').addEventListener('click', () => {
            // THE BIG BANG
            STATE.phase = 'YES';
            
            // Haptic Boom
            if(navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 1000]);

            // Firework Explosion
            for(let i=0; i<300; i++) {
                STATE.particles.push(new Particle(STATE.width/2, STATE.height/2, Math.random() > 0.5 ? '#ffaa00' : '#ffffff'));
            }

            // White Out
            const screen = document.getElementById('final-screen');
            screen.style.opacity = 1;
            
            setTimeout(() => {
    document.querySelector('.final-msg').style.opacity = 1;
    document.querySelector('.final-msg').style.transform = "scale(1)";
}, 1000);

// auto move to last page
setTimeout(() => {
    document.body.style.transition = "opacity 1.5s ease";
    document.body.style.opacity = 0;
    setTimeout(() => {
        window.location.href = "the_beginning.html";
    }, 1000);
}, 6000);
        });

        // Start
        init();

    </script>
</body>
</html>
